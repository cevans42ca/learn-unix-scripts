.PHONY: clean dist distclean install configure run replacetarget

include config.status

run: configure

flags/configuretarget:
	./configure

configure: flags/configuretarget

replace: flags/configuretarget flags/replacetarget

clean: gitclean
	rm -f dist/bin/*
	rm -f flags/replacetarget
	rm -f replace
	rm -f Makefile
	rm -f docker/Makefile 
	rm -f config.status
	rm -f docker/config.status
	rm -f docker/flags/buildtarget
	rm -f docker/flags/volumetarget
	@echo
	@echo "Run the ./configure script to create the Makefile."

gitclean:
	rm -f flags/configuretarget

scripts = master-scripts/learn-master master-scripts/checkmain-master master-scripts/check-master
replaced_scripts = dist/bin/learn dist/bin/checkmain dist/bin/check

flags/replacetarget: $(scripts) replacements/* flags/configuretarget
	./replace-all
	touch flags/replacetarget
	@echo "Scripts prepared in ./dist/bin.  Review them if you like.  When you're ready,"
	@echo "copy these into any directory on the students' PATH or update the install"
	@echo "target in the Makefile and use that."

replacetarget: flags/replacetarget

docker/bin/%: dist/bin/%
	cp dist/bin/$* docker/bin/$*

dockerinstall: flags/replacetarget docker/bin/*

install: flags/replacetarget
	cp dist/bin/* /usr/local/bin/

dockerrun: dockerinstall
	cd docker && make createuservolume
	cd docker && make run

dist:
	mkdir -p dist
	zip dist/learn-unix-scripts-dist.zip dist/bin/learn dist/bin/check dist/bin/checkmain LICENSE dist-readme
	tar czvf dist/learn-unix-scripts-dist.tar.gz dist/bin/learn dist/bin/check dist/bin/checkmain LICENSE dist-readme

distclean:
	rm -Rf dist
